mysql> SHOW PROCEDURE STATUS WHERE Db = 'backlog_db';
+------------+---------------------------+-----------+-------------------------+---------------------+---------------------+---------------+---------+----------------------+----------------------+--------------------+
| Db         | Name                      | Type      | Definer                 | Modified            | Created             | Security_type | Comment | character_set_client | collation_connection | Database Collation |
+------------+---------------------------+-----------+-------------------------+---------------------+---------------------+---------------+---------+----------------------+----------------------+--------------------+
| backlog_db | GetOrInsertHospitalData   | PROCEDURE | BasicRoboUser@%         | 2025-01-21 11:11:48 | 2025-01-21 11:11:48 | DEFINER       |         | cp932
      | cp932_japanese_ci    | utf8mb4_bin        |
| backlog_db | get_available_staff       | PROCEDURE | BasicRoboUser@%         | 2024-11-27 11:38:36 | 2024-11-27 11:38:36 | DEFINER       |         | cp932
      | cp932_japanese_ci    | utf8mb4_bin        |
| backlog_db | get_hospital_info         | PROCEDURE | BasicRoboUser@localhost | 2024-11-05 09:56:57 | 2024-11-05 09:56:57 | DEFINER       |         | cp932
      | cp932_japanese_ci    | utf8mb4_bin        |
| backlog_db | get_pending_accounts      | PROCEDURE | BasicRoboUser@localhost | 2025-01-28 11:34:35 | 2025-01-28 11:34:35 | DEFINER       |         | cp932
      | cp932_japanese_ci    | utf8mb4_bin        |
| backlog_db | get_team_pending_accounts | PROCEDURE | BasicRoboUser@%         | 2025-01-28 10:24:59 | 2025-01-28 10:24:59 | DEFINER       |         | cp932
      | cp932_japanese_ci    | utf8mb4_bin        |
| backlog_db | InsertPendingAccount      | PROCEDURE | BasicRoboUser@%         | 2025-02-27 15:04:05 | 2025-02-27 15:04:05 | DEFINER       |         | cp932
      | cp932_japanese_ci    | utf8mb4_bin        |
| backlog_db | revert_assignment         | PROCEDURE | BasicRoboUser@%         | 2025-01-28 10:26:30 | 2025-01-28 10:26:30 | DEFINER       |         | cp932
      | cp932_japanese_ci    | utf8mb4_bin        |
| backlog_db | update_assignment         | PROCEDURE | BasicRoboUser@%         | 2025-01-28 10:27:14 | 2025-01-28 10:27:14 | DEFINER       |         | cp932
      | cp932_japanese_ci    | utf8mb4_bin        |
| backlog_db | update_staff_status       | PROCEDURE | BasicRoboUser@%         | 2024-11-27 11:38:52 | 2024-11-27 11:38:52 | DEFINER       |         | cp932
      | cp932_japanese_ci    | utf8mb4_bin        |
+------------+---------------------------+-----------+-------------------------+---------------------+---------------------+---------------+---------+----------------------+----------------------+--------------------+
9 rows in set (0.01 sec)

mysql>

mysql>
mysql> SHOW CREATE PROCEDURE GetOrInsertHospitalData;
+-------------------------+-----------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure               | sql_mode                                                                                                              | Create Procedure




                                                                                                                                                    | character_set_client | collation_connection | Database Collation |
+-------------------------+-----------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| GetOrInsertHospitalData | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION | CREATE DEFINER=`BasicRoboUser`@`%` PROCEDURE `GetOrInsertHospitalData`(
    IN p_hospital_name VARCHAR(100),
    IN p_electronic_medical_record_name VARCHAR(100),
    IN p_team VARCHAR(100),
    IN p_issue_key VARCHAR(20)
)
BEGIN
    DECLARE v_hospital_id INT;
    DECLARE v_existing_team VARCHAR(100);


    SET v_hospital_id = CAST(SUBSTRING_INDEX(p_issue_key, '-', -1) AS SIGNED);


    SELECT チーム
    INTO v_existing_team
    FROM tbl_hospital
    WHERE 病院ID = v_hospital_id
    LIMIT 1;

    IF v_existing_team IS NULL THEN

        INSERT INTO tbl_hospital (病院ID, 病院名, 電子カルテ名, チーム)
        VALUES (v_hospital_id, p_hospital_name, p_electronic_medical_record_name, p_team);

        SELECT
            v_hospital_id AS hospital_id,
            p_team AS team,
            'データが正常に挿入されました。' AS message;
    ELSE

        UPDATE tbl_hospital
        SET
            病院名 = p_hospital_name,
            電子カルテ名 = p_electronic_medical_record_name,
            チーム = p_team
        WHERE 病院ID = v_hospital_id
        AND (
            病院名 <> p_hospital_name OR
            電子カルテ名 <> p_electronic_medical_record_name OR
            (チーム <> p_team OR チーム IS NULL)
        );

        SELECT
            v_hospital_id AS hospital_id,
            p_team AS team,
            'データを確認しました。' AS message;
    END IF;
END | cp932                | cp932_japanese_ci    | utf8mb4_bin        |
+-------------------------+-----------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.00 sec)

mysql>

mysql>
mysql>
mysql> SHOW CREATE PROCEDURE get_available_staff;
+---------------------+-----------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure           | sql_mode                                                                                                              | Create Procedure
                                                                                                                                                    | character_set_client | collation_connection | Database Collation |
+---------------------+-----------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| get_available_staff | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION | CREATE DEFINER=`BasicRoboUser`@`%` PROCEDURE `get_available_staff`()
BEGIN
    SELECT スタッフID, 名前, 最終割り当て時間
    FROM tbl_staff
    WHERE ステータス = '在席'
    ORDER BY 最終割り当て時間 ASC;
END | cp932                | cp932_japanese_ci    | utf8mb4_bin        |
+---------------------+-----------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.00 sec)

mysql>
mysql>
mysql>
mysql> SHOW CREATE PROCEDURE get_hospital_info;
+-------------------+-----------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure         | sql_mode                                                                                                              | Create Procedure                                                                                                                                                                                 | character_set_client | collation_connection | Database Collation |
+-------------------+-----------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| get_hospital_info | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION | CREATE DEFINER=`BasicRoboUser`@`localhost` PROCEDURE `get_hospital_info`(IN p_hospital_id INT)
BEGIN
    SELECT 病院名, 電子カルテ名
    FROM tbl_hospital
    WHERE 病院ID = p_hospital_id;
END | cp932                | cp932_japanese_ci    | utf8mb4_bin        |
+-------------------+-----------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.00 sec)

mysql>
mysql> SHOW CREATE PROCEDURE get_pending_accounts;
+----------------------+-----------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure            | sql_mode                                                                                                              | Create Procedure
                                                                                                                                                                          | character_set_client | collation_connection | Database Collation |
+----------------------+-----------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| get_pending_accounts | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION | CREATE DEFINER=`BasicRoboUser`@`localhost` PROCEDURE `get_pending_accounts`()
BEGIN
    SELECT 会計ID, 病院ID, 患者ID, 診察日, 診察時間
    FROM tbl_pendingaccounts
    WHERE チケット状態 = '未割当'
    ORDER BY 作成時間 ASC;
END | cp932                | cp932_japanese_ci    | utf8mb4_bin        |
+----------------------+-----------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.00 sec)

mysql>

mysql>
mysql> SHOW CREATE PROCEDURE get_team_pending_accounts;
+---------------------------+-----------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure                 | sql_mode                                                                                                              | Create Procedure




                                                                                                                                                      | character_set_client | collation_connection | Database Collation |
+---------------------------+-----------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| get_team_pending_accounts | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION | CREATE DEFINER=`BasicRoboUser`@`%` PROCEDURE `get_team_pending_accounts`(
    IN p_team VARCHAR(100)
)
BEGIN
    IF p_team IS NULL THEN
        SELECT
            pa.会計ID,
            pa.病院ID,
            pa.患者ID,
            pa.診察日,
            pa.診察時間,
            h.チーム,
            pa.作成時間
        FROM
            tbl_pendingaccounts pa
            LEFT JOIN tbl_hospital h ON pa.病院ID = h.病院ID
        WHERE
            pa.チケット状態 IN ('未割当', '差戻')
        ORDER BY
            CASE pa.チケット状態
                WHEN '差戻' THEN 0
                ELSE 1
            END,
            pa.作成時間 ASC;
    ELSE
        SELECT
            pa.会計ID,
            pa.病院ID,
            pa.患者ID,
            pa.診察日,
            pa.診察時間,
            h.チーム,
            pa.作成時間
        FROM
            tbl_pendingaccounts pa
            JOIN tbl_hospital h ON pa.病院ID = h.病院ID
        WHERE
            pa.チケット状態 IN ('未割当', '差戻')
            AND h.チーム = p_team
        ORDER BY
            CASE pa.チケット状態
                WHEN '差戻' THEN 0
                ELSE 1
            END,
            pa.作成時間 ASC;
    END IF;
END | cp932                | cp932_japanese_ci    | utf8mb4_bin        |
+---------------------------+-----------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.00 sec)

mysql>
mysql>
mysql>
mysql> SHOW CREATE PROCEDURE InsertPendingAccount;
+----------------------+-----------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure            | sql_mode
                       | Create Procedure







                                                                                          | character_set_client | collation_connection | Database Collation |
+----------------------+-----------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| InsertPendingAccount | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION | CREATE DEFINER=`BasicRoboUser`@`%` PROCEDURE `InsertPendingAccount`(
    IN p_hospital_id INT,
    IN p_patient_id VARCHAR(50),
    IN p_department VARCHAR(100),
    IN p_exam_date DATE,
    IN p_exam_time TIME,
    IN p_re_account_flag TINYINT(1)
)
BEGIN
    DECLARE v_count INT;
    DECLARE v_new_id INT;
    DECLARE v_existing_id INT;

    SELECT COUNT(*), MIN(会計ID) INTO v_count, v_existing_id
    FROM tbl_pendingaccounts
    WHERE 病院ID = p_hospital_id
      AND 患者ID = p_patient_id
      AND 診察日 = p_exam_date
      AND 診察時間 = p_exam_time;

    IF v_count = 0 THEN
        SELECT COALESCE(MAX(会計ID), 0) + 1 INTO v_new_id FROM tbl_pendingaccounts;
        INSERT INTO tbl_pendingaccounts
            (会計ID, 病院ID, 患者ID, 診療科, 診察日, 診察時間, チケット状態, 作成時間, 再会計フラグ)
        VALUES
            (v_new_id, p_hospital_id, p_patient_id, p_department, p_exam_date, p_exam_time, '未割当', NOW(), p_re_account_flag);

        SELECT v_new_id AS new_account_id, '新規データが挿入されました' AS message, 0 AS updated_existing;
    ELSE
        IF p_re_account_flag = 1 THEN
            UPDATE tbl_pendingaccounts
            SET 再会計フラグ = 1,
                診療科 = CASE
                           WHEN 診療科 IS NULL OR 診療科 = '' THEN p_department
                           ELSE 診療科
                         END
            WHERE 会計ID = v_existing_id;

            SELECT v_existing_id AS new_account_id, '既存レコードの再会計フラグを更新しました' AS message, 1 AS updated_existing;
        ELSE
            SELECT v_existing_id AS new_account_id, '既存レコードが見つかりました（更新なし）' AS message, 2 AS updated_existing;
        END IF;
    END IF;
END | cp932                | cp932_japanese_ci    | utf8mb4_bin        |
+----------------------+-----------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.00 sec)

mysql>
mysql>
mysql> SHOW CREATE PROCEDURE revert_assignment;
+-------------------+-----------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure         | sql_mode                                                                                                              | Create Procedure



                                                                                                                                | character_set_client | collation_connection | Database Collation |
+-------------------+-----------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| revert_assignment | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION | CREATE DEFINER=`BasicRoboUser`@`%` PROCEDURE `revert_assignment`(
    IN p_staff_id INT,
    IN p_assignment_id INT,
    IN p_backlog_ticket VARCHAR(20)
)
BEGIN
    DECLARE v_account_id INT;

    START TRANSACTION;

    SELECT 会計ID INTO v_account_id
    FROM tbl_assignmenthistory
    WHERE 割り当てID = p_assignment_id;

    IF v_account_id IS NOT NULL THEN
        UPDATE tbl_staff
        SET ステータス = '不在'
        WHERE スタッフID = p_staff_id;

        UPDATE tbl_pendingaccounts
        SET チケット状態 = '差戻'
        WHERE 会計ID = v_account_id;

        UPDATE tbl_assignmenthistory
        SET
            差戻時間 = NOW(),
            差戻元スタッフID = p_staff_id,
            元チケット番号 = p_backlog_ticket
        WHERE 割り当てID = p_assignment_id;
    END IF;

    COMMIT;
END | cp932                | cp932_japanese_ci    | utf8mb4_bin        |
+-------------------+-----------------------------------------------------------------------------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.00 sec)

mysql>

mysql>
mysql>
mysql> SHOW CREATE PROCEDURE update_assignment;
+-------------------+-----------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure         | sql_mode                                                                                                              | Create Procedure


                                                                                                                                                                                                       | character_set_client | collation_connection | Database Collation |
+-------------------+-----------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| update_assignment | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION | CREATE DEFINER=`BasicRoboUser`@`%` PROCEDURE `update_assignment`(
    IN p_account_id INT,
    IN p_staff_id INT,
    IN p_backlog_issue_id VARCHAR(50),
    IN p_original_ticket_id VARCHAR(20)
)
BEGIN
    START TRANSACTION;

    UPDATE tbl_pendingaccounts
    SET チケット状態 = '割当済'
    WHERE 会計ID = p_account_id;

    INSERT INTO tbl_assignmenthistory
    (会計ID, スタッフID, 割り当て時間, Backlogチケット番号, 元チケット番号)
    VALUES
    (p_account_id, p_staff_id, NOW(), p_backlog_issue_id, p_original_ticket_id);

    UPDATE tbl_staff
    SET 最終割り当て時間 = NOW(),
        ステータス = '在席(処理中)'
    WHERE スタッフID = p_staff_id;

    COMMIT;
END | cp932                | cp932_japanese_ci    | utf8mb4_bin        |
+-------------------+-----------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.00 sec)

mysql>
mysql>
mysql> SHOW CREATE PROCEDURE update_staff_status;
+---------------------+-----------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| Procedure           | sql_mode                                                                                                              | Create Procedure


    | character_set_client | collation_connection | Database Collation |
+---------------------+-----------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
| update_staff_status | ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION | CREATE DEFINER=`BasicRoboUser`@`%` PROCEDURE `update_staff_status`(
    IN p_backlog_user_id VARCHAR(100),
    IN p_name VARCHAR(100),
    IN p_status ENUM('在席', '在席(処理中)', '不在'),
    IN p_sync_time DATETIME
)
BEGIN
    INSERT INTO tbl_staff (BacklogユーザーID, 名前, ステータス, 最終同期時間)
    VALUES (p_backlog_user_id, p_name, p_status, p_sync_time)
    ON DUPLICATE KEY UPDATE
    名前 = p_name,
    ステータス = p_status,
    最終同期時間 = p_sync_time;
END | cp932                | cp932_japanese_ci    | utf8mb4_bin        |
+---------------------+-----------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------+----------------------+--------------------+
1 row in set (0.00 sec)

mysql>