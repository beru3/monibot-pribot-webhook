<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ウェブフックモニター - OASIS INNOVATION</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" href="./assets/favicon-BPhJjKpZ.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="./assets/apple-touch-icon-DjI6rx6h.png">
    <link rel="stylesheet" href="./assets/common-D6Lta79p.css">
    <link rel="stylesheet" href="./assets/webhook-monitor.css">
</head>

<body class="min-h-dynamic bg-gray-100 flex flex-col">
    <main class="flex-grow flex flex-col mt-8">
        <div class="w-full max-w-4xl mx-auto px-8 lg:px-0">
            <!-- ヘッダー部分 -->
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center">
                    <img src="./assets/logo-002-D24WXjc6.png" alt="MoniBot" class="h-10 mr-4">
                    <h1 class="text-3xl font-bold">ウェブフックモニター</h1>
                </div>
                <div>
                    <a href="/webhook_client" class="bg-blue-500 text-white py-2 px-4 rounded-lg shadow-md hover:bg-blue-600">
                        <i class="bi bi-send mr-2"></i>テストクライアント
                    </a>
                </div>
            </div>

            <!-- 統計情報 -->
            <div class="bg-white shadow-md rounded-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">サーバー統計</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-500 mb-1">接続状態</p>
                        <div class="flex items-center">
                            <span id="connection-status" class="px-3 py-1 rounded-full text-sm bg-red-100 text-red-700">未接続</span>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-500 mb-1">接続クライアント数</p>
                        <p id="active-clients" class="text-xl font-bold">0</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-gray-500 mb-1">キュー内イベント数</p>
                        <p id="events-in-queue" class="text-xl font-bold">0</p>
                    </div>
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <div>
                        <p class="text-gray-500">サーバー時間: <span id="server-time" class="font-medium">--</span></p>
                        <p class="text-gray-500">最終更新: <span id="last-update" class="font-medium">--</span></p>
                    </div>
                    <button id="connection-toggle" class="bg-green-500 text-white py-2 px-4 rounded-lg shadow-md hover:bg-green-600">
                        接続する
                    </button>
                </div>
            </div>

            <!-- イベント一覧 -->
            <div class="bg-white shadow-md rounded-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">ウェブフックイベント</h2>
                <div id="events" class="bg-gray-50 rounded-lg p-4" style="height: 500px; overflow-y: auto;">
                    <p id="no-events" class="text-gray-500 text-center py-8">イベントはまだありません...</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg ...  py-4 px-4 lg:px-8 mt-auto" style="padding-bottom: calc(16px + env(safe-area-inset-bottom));">
        <div class="mx-auto flex justify-between items-center">
            <!-- 左端: ホームへ戻るボタン -->
            <div class="flex items-center space-x-4">
                <a href="index.html" class="bg-gray-500 text-white py-2 px-4 rounded-lg shadow-md hover:bg-gray-600 flex items-center justify-center">
                    <i class="bi bi-house-door mr-2"></i>ホームへ戻る
                </a>
            </div>

            <!-- 右端: アイコンとバージョン -->
            <div class="flex items-center">
                <img src="/assets/logo-002-D24WXjc6.png" alt="logo" class="h-8 mr-4 object-contain">
                <img src="./assets/logo-001-D8JCHPth.png" alt="logo" class="h-8 mr-4 object-contain">
                <span class="text-sm">Ver. 1.0.0</span>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let eventSource = null;
            const connectionToggle = document.getElementById('connection-toggle');
            const connectionStatus = document.getElementById('connection-status');
            const eventsContainer = document.getElementById('events');
            const noEventsMsg = document.getElementById('no-events');
            let eventsReceived = 0;
            
            // 接続トグル
            connectionToggle.addEventListener('click', function() {
                if (eventSource) {
                    closeEventSource();
                    connectionToggle.textContent = '接続する';
                    connectionToggle.classList.remove('bg-red-500', 'hover:bg-red-600');
                    connectionToggle.classList.add('bg-green-500', 'hover:bg-green-600');
                    connectionStatus.textContent = '未接続';
                    connectionStatus.classList.remove('bg-green-100', 'text-green-700');
                    connectionStatus.classList.add('bg-red-100', 'text-red-700');
                } else {
                    connectEventSource();
                    connectionToggle.textContent = '切断する';
                    connectionToggle.classList.remove('bg-green-500', 'hover:bg-green-600');
                    connectionToggle.classList.add('bg-red-500', 'hover:bg-red-600');
                }
            });
            
            // SSE接続
            function connectEventSource() {
                eventSource = new EventSource('/events');
                
                // 接続時
                eventSource.onopen = function() {
                    connectionStatus.textContent = '接続済み';
                    connectionStatus.classList.remove('bg-red-100', 'text-red-700');
                    connectionStatus.classList.add('bg-green-100', 'text-green-700');
                    updateLastUpdate();
                };
                
                // エラー発生時
                eventSource.onerror = function() {
                    connectionStatus.textContent = '接続エラー';
                    connectionStatus.classList.remove('bg-green-100', 'text-green-700');
                    connectionStatus.classList.add('bg-yellow-100', 'text-yellow-700');
                    updateLastUpdate();
                };
                
                // 接続イベント受信時
                eventSource.addEventListener('connected', function(e) {
                    const data = JSON.parse(e.data);
                    console.log('ウェブフックストリームに接続:', data);
                });
                
                // 履歴イベント受信時
                eventSource.addEventListener('history', function(e) {
                    const event = JSON.parse(e.data);
                    appendEvent(event, true);
                });
                
                // ウェブフックイベント受信時
                eventSource.addEventListener('webhook', function(e) {
                    const event = JSON.parse(e.data);
                    appendEvent(event, false);
                });
            }
            
            // SSE切断
            function closeEventSource() {
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
            }
            
            // イベント追加
            function appendEvent(event, isHistory) {
                if (eventsReceived === 0) {
                    noEventsMsg.style.display = 'none';
                }
                
                const eventElement = document.createElement('div');
                eventElement.className = 'bg-white shadow-sm rounded p-3 mb-3';
                
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center';
                
                const timestamp = document.createElement('span');
                timestamp.className = 'text-gray-500 text-sm';
                
                // 表示時刻を追加
                const displayTime = new Date().toLocaleTimeString();
                timestamp.innerHTML = `
                    <i class="bi bi-clock mr-1"></i>${event.timestamp} 
                    <span class="text-xs text-gray-400">from ${event.source_ip} (${event.method}) ${isHistory ? '[履歴]' : ''}</span>
                `;
                
                const method = document.createElement('span');
                method.className = `px-2 py-1 rounded-full text-xs ${event.method === 'POST' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`;
                method.textContent = event.method;
                
                header.appendChild(timestamp);
                header.appendChild(method);
                
                const dataElement = document.createElement('pre');
                dataElement.className = 'bg-gray-50 p-3 mt-2 text-sm rounded overflow-x-auto max-h-48';
                dataElement.textContent = JSON.stringify(event.data, null, 2);
                
                eventElement.appendChild(header);
                eventElement.appendChild(dataElement);
                
                eventsContainer.insertBefore(eventElement, eventsContainer.firstChild);
                eventsReceived++;
                updateLastUpdate();
            }
            
            // サーバー統計情報を更新
            function updateStats() {
                fetch('/api/stats')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('active-clients').textContent = data.active_clients;
                        document.getElementById('events-in-queue').textContent = data.events_in_queue;
                        document.getElementById('server-time').textContent = data.server_time;
                        updateLastUpdate();
                    })
                    .catch(error => {
                        console.error('統計情報の取得エラー:', error);
                    });
            }
            
            // 最終更新時間を更新
            function updateLastUpdate() {
                const now = new Date();
                document.getElementById('last-update').textContent = now.toLocaleTimeString();
            }
            
            // 初期更新と定期更新設定
            updateStats();
            setInterval(updateStats, 1000);
        });
    </script>
</body>

</html>